<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, beginning-scale=1">
  <title>Arabic Letters Adventure! üåü</title>
  <style>
    :root { 
      --bg: #e8f5ff;
      --card: #fff;
      --text: #2c3e50;
      --muted: #7f8c8d;
      --accent: #ff6b6b;
      --correct: #4cd137;
      --wrong: #ff4757;
    }
    * { box-sizing: border-box; }
    @import url('https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap');
    body { 
      margin: 0; 
      min-height: 100vh;
      font-family: 'Bubblegum Sans', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      background-image: linear-gradient(45deg, #fff 25%, transparent 25%),
                        linear-gradient(-45deg, #fff 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #fff 75%),
                        linear-gradient(-45deg, transparent 75%, #fff 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      background-attachment: fixed;
      overflow-y: auto;
      overflow-x: hidden;
    }
    header { 
      padding: 18px 20px 22px; 
      background: #fff; 
      border-bottom: 3px solid #ffeaa7; 
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    h1 { 
      margin: 0; 
      font-size: 24px;
      color: #e17055;
      text-shadow: 2px 2px 0 #ffeaa7;
      text-align: center;
    }
    main { 
      margin-top: 160px; 
      padding: 24px 16px 80px; 
      display: flex;
      justify-content: center;
    }
    .quiz-shell {
      width: 100%;
      max-width: 860px;
    }
    .card { 
      background: var(--card); 
      border: none; 
      border-radius: 28px; 
      padding: 32px 28px; 
      box-shadow: 0 20px 45px rgba(0,0,0,0.12);
      transform: translateY(0);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 28px 55px rgba(0,0,0,0.18);
    }
    .quiz-card {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .quiz-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .quiz-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #6c5ce7;
      background: rgba(108,92,231,0.12);
      padding: 8px 14px;
      border-radius: 999px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    #quiz {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .arabic { 
      font-family: 'Scheherazade New', 'Noto Naskh Arabic', 'Noto Kufi Arabic', 'Geeza Pro', 'Arial', sans-serif;
      font-size: 100px; 
      line-height: 1.2; 
      text-align: center; 
      direction: rtl;
      color: #2d3436;
      text-shadow: 2px 2px 0 #dfe6e9;
    }
    .hint { 
      color: var(--muted); 
      font-size: 18px; 
      text-align: center;
      margin: 15px 0;
      color: #6c5ce7;
    }
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
      gap: 15px; 
      margin-top: 20px; 
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
    .quiz-card .grid button { 
      font: inherit; 
      padding: 15px 20px; 
      border-radius: 15px; 
      border: 3px solid #a8e6cf; 
      background: #fff; 
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 18px;
      color: #2d3436;
    }
    .quiz-card .grid button:hover { 
      border-color: #3fc1c9;
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .quiz-card .grid button.correct { 
      background: #a8e6cf; 
      border-color: #55efc4;
      animation: correct 0.5s ease;
    }
    .quiz-card .grid button.wrong { 
      background: #ffb8b8; 
      border-color: #ff7675;
      animation: wrong 0.5s ease;
    }
    button.help-btn {
      border: none;
      background: linear-gradient(135deg, #ff6b6b, #ffd56f);
      color: #fff;
      padding: 10px 20px;
      border-radius: 999px;
      font-weight: 600;
      box-shadow: 0 15px 30px rgba(255,107,107,0.25);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    button.help-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 22px 36px rgba(255,107,107,0.25);
    }
    .quiz-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .next-btn {
      border: none;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #fff;
      padding: 12px 24px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 18px 32px -18px rgba(59,130,246,0.7);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 24px 36px -18px rgba(59,130,246,0.75);
    }
    .next-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(99,102,241,0.35);
    }
    @keyframes correct {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes wrong {
      0% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
      100% { transform: translateX(0); }
    }
    .mode-toggle {
      display: inline-flex;
      align-items: stretch;
      gap: 8px;
      padding: 6px;
      background: rgba(236, 244, 255, 0.85);
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(108,92,231,0.18);
    }
    .mode-btn {
      border: none;
      background: transparent;
      color: #6c5ce7;
      font-weight: 600;
      font-size: 15px;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .mode-btn:hover {
      background: rgba(108,92,231,0.12);
    }
    .mode-btn.active {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: #fff;
      box-shadow: 0 12px 24px -12px rgba(108,92,231,0.5);
    }
    .mode-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(108,92,231,0.3);
    }
    .score { 
      font-weight: 700; 
      font-size: 18px;
      background: #f8fafc;
      padding: 10px 18px;
      border-radius: 999px;
      box-shadow: 0 12px 24px -18px rgba(15,23,42,0.55);
      color: #1e293b;
    }
    .name { font-size: 18px; font-weight: 600; margin-top: 6px; text-align: center; }
    .forms { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; direction: rtl; }
    .box { border: 1px dashed #ddd; border-radius: 8px; padding: 8px; text-align: center; }
    .small { font-size: 44px; }
    .muted { color: var(--muted); font-size: 12px; margin-top: 4px; text-align: center; }
    .reference-panel {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.35s ease;
      z-index: 1000;
    }
    .reference-panel.active {
      pointer-events: auto;
      opacity: 1;
    }
    .ref-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.72);
      backdrop-filter: blur(4px);
    }
    .ref-card {
      position: relative;
      background: #111827;
      color: #f9fafb;
      width: min(92vw, 900px);
      border-radius: 28px;
      padding: 48px 64px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
      box-shadow: 0 40px 90px rgba(0,0,0,0.45);
    }
    .ref-card:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.25), 0 40px 90px rgba(0,0,0,0.45);
    }
    .ref-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.12);
      color: #f9fafb;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      font-size: 26px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .ref-close:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.05);
    }
    .ref-slider {
      position: relative;
      width: 100%;
      padding: 0 64px;
    }
    .ref-slide {
      background: #0f172a;
      border-radius: 20px;
      padding: 32px 48px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: center;
      text-align: center;
    }
    .ref-letter-name {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .ref-heading {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.7);
    }
    .ref-forms {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 18px;
      width: 100%;
    }
    .ref-forms-row {
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .ref-forms-row .label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(255,255,255,0.72);
    }
    .ref-forms-row .glyph {
      font-size: 64px;
      line-height: 1;
      font-family: 'Scheherazade New', 'Noto Naskh Arabic', 'Noto Kufi Arabic', 'Geeza Pro', 'Arial', sans-serif;
      color: #fdfdfd;
      text-shadow: 0 12px 28px rgba(0,0,0,0.35);
    }
    .ref-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.12);
      color: #f9fafb;
      font-size: 32px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: background 0.2s ease, transform 0.2s ease;
      z-index: 2;
    }
    .ref-nav.prev { left: 16px; }
    .ref-nav.next { right: 16px; }
    .ref-nav:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-50%) scale(1.05);
    }
    .ref-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .ref-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      border: none;
      padding: 0;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    .ref-dot.active {
      background: var(--accent);
      transform: scale(1.3);
    }
    .ref-nav:focus-visible,
    .ref-close:focus-visible,
    button.help-btn:focus-visible,
    .ref-dot:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.4);
    }
    .ref-tip {
      font-size: 13px;
      color: rgba(255,255,255,0.68);
      text-align: center;
      line-height: 1.5;
    }
    .ref-tip code {
      color: #fde68a;
    }
    body.no-scroll {
      overflow: hidden;
    }
    @media (max-width: 960px) {
      .quiz-shell { max-width: 720px; }
      .ref-card { width: min(94vw, 760px); }
    }
    @media (max-width: 720px) {
      header { padding: 12px 16px; }
      h1 { font-size: 20px; }
      main { padding: 16px 12px 60px; }
      .card { padding: 24px 20px; border-radius: 24px; }
      .quiz-head { flex-direction: column; align-items: stretch; }
      .quiz-tag { width: fit-content; }
      button.help-btn { width: 100%; justify-content: center; }
      .mode-toggle { flex-wrap: wrap; justify-content: center; }
      .mode-btn { flex: 1 1 140px; }
      .arabic { font-size: 72px; }
      .grid { grid-template-columns: 1fr; gap: 12px; max-width: 100%; }
      .quiz-card .grid button { width: 100%; }
      .ref-card { padding: 32px 24px; border-radius: 24px; width: min(95vw, 540px); }
      .ref-slide { padding: 24px 20px; }
      .ref-slider { padding: 0 36px; }
      .ref-nav { width: 48px; height: 48px; font-size: 26px; }
      .ref-forms { grid-template-columns: 1fr; }
    }
    /* Top-level tabs (Letters vs. Quiz Prep) */
    .top-tabs { display: inline-flex; gap: 8px; background: rgba(15,23,42,0.04); padding: 6px; border-radius: 999px; box-shadow: inset 0 0 0 1px rgba(108,92,231,0.12); }
    .top-tab { border: none; background: transparent; color: #111827; font-weight: 700; font-size: 14px; padding: 10px 16px; border-radius: 999px; cursor: pointer; transition: all 0.2s ease; }
    .top-tab:hover { background: rgba(108,92,231,0.08); }
    .top-tab.active { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: #fff; box-shadow: 0 10px 22px -12px rgba(108,92,231,0.5); }
    /* Prep tab styles */
    .prep-head { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .prep-mode-toggle { display: inline-flex; align-items: stretch; gap: 8px; padding: 6px; background: rgba(236, 244, 255, 0.85); border-radius: 999px; box-shadow: inset 0 0 0 1px rgba(108,92,231,0.18); }
    .prep-mode-btn { border: none; background: transparent; color: #2563eb; font-weight: 700; font-size: 14px; padding: 10px 16px; border-radius: 999px; cursor: pointer; transition: all 0.2s ease; }
    .prep-mode-btn:hover { background: rgba(37,99,235,0.12); }
    .prep-mode-btn.active { background: linear-gradient(135deg, #38bdf8, #6366f1); color: #fff; box-shadow: 0 12px 24px -12px rgba(37,99,235,0.5); }
    .prep-container { display: flex; flex-direction: column; gap: 18px; }
    .prep-rtl { direction: rtl; font-family: 'Scheherazade New', 'Noto Naskh Arabic', 'Noto Kufi Arabic', 'Geeza Pro', 'Arial', sans-serif; }
    .prep-arabic-word { font-size: 64px; text-align: center; color: #111827; text-shadow: 1px 1px 0 #dfe6e9; }
    .prep-muted { color: var(--muted); text-align: center; }
    .tiles { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .tile { border: 2px solid #a8e6cf; background: #fff; border-radius: 14px; padding: 10px 14px; font-size: 36px; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease; }
    .tile:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.08); }
    .tile.used { background: #e2e8f0; color: #64748b; border-color: #cbd5e1; cursor: not-allowed; }
    .slots { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .slot { min-width: 40px; min-height: 48px; border: 2px dashed #cbd5e1; border-radius: 10px; padding: 6px 10px; display: inline-flex; align-items: center; justify-content: center; font-size: 36px; background: #f8fafc; }
    .slot.filled { border-style: solid; border-color: #94a3b8; background: #fff; }
    .prep-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .prep-btn { border: none; background: linear-gradient(135deg, #38bdf8, #6366f1); color: #fff; padding: 10px 18px; border-radius: 999px; font-weight: 700; cursor: pointer; box-shadow: 0 12px 24px -12px rgba(59,130,246,0.7); }
    .prep-btn.secondary { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 12px 24px -12px rgba(34,197,94,0.6); }
    .prep-two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .prep-col { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; }
    .prep-col h3 { margin: 0 0 10px; font-size: 14px; letter-spacing: 0.06em; text-transform: uppercase; color: #64748b; }
    .pair-item { border: 2px solid #f59e0b; background: #fff7ed; color: #92400e; border-radius: 12px; padding: 10px 12px; font-size: 22px; cursor: pointer; transition: transform 0.1s ease, background 0.2s ease; }
    .pair-item:hover { transform: translateY(-1px); }
    .pair-item.selected { outline: 3px solid #f59e0b; }
    .pair-item.matched { background: #dcfce7; border-color: #22c55e; color: #14532d; cursor: default; }
    .prep-input { font-size: 22px; padding: 10px 12px; border-radius: 12px; border: 2px solid #cbd5e1; width: 100%; direction: rtl; }
    .status { text-align: center; font-weight: 700; }
  </style>
</head>
<body>
<header>
  <div class="top-tabs" role="tablist" aria-label="Choose section">
    <button type="button" class="top-tab active" data-tab="letters" aria-selected="true">Letters</button>
    <button type="button" class="top-tab" data-tab="prep" aria-selected="false">Quiz Prep</button>
  </div>
  <h1>Arabic Letters Adventure! üåü</h1>
  <div class="mode-toggle" role="group" aria-label="Select game mode">
    <button type="button" class="mode-btn active" data-mode="form-to-name" aria-pressed="true">Form ‚Üí Name</button>
    <button type="button" class="mode-btn" data-mode="name-to-form" aria-pressed="false">Name ‚Üí Form</button>
  </div>
</header>
<main>
  <div class="quiz-shell">
    <section class="card quiz-card" id="letters-section">
      <div class="quiz-head">
        <span class="quiz-tag">Question</span>
        <button type="button" id="help" class="help-btn" aria-haspopup="dialog" aria-controls="reference-panel">Help</button>
      </div>
      <div id="quiz"></div>
      <div class="quiz-actions">
        <span class="score" id="score">0 / 0</span>
        <button id="next" type="button" class="next-btn">Next <span aria-hidden="true">‚ñ∂</span></button>
      </div>
    </section>
    <!-- Quiz Prep Section -->
    <section class="card" id="prep-section" hidden>
      <div class="prep-head">
        <span class="quiz-tag">Quiz Prep</span>
        <div class="prep-mode-toggle" role="group" aria-label="Select prep mode">
          <button type="button" class="prep-mode-btn active" data-prep="letter-order">Letter Order</button>
          <button type="button" class="prep-mode-btn" data-prep="phonetic-match">Phonetic Match</button>
          <button type="button" class="prep-mode-btn" data-prep="type-it">Type It</button>
          <button type="button" class="prep-mode-btn" data-prep="flashcards">Flashcards</button>
        </div>
      </div>
      <div id="prep-container" class="prep-container"></div>
    </section>
  </div>
</main>

<div id="reference-panel" class="reference-panel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="ref-heading">
  <div class="ref-backdrop"></div>
  <div class="ref-card" tabindex="-1">
    <button type="button" class="ref-close" aria-label="Close reference panel">√ó</button>
    <div class="ref-heading" id="ref-heading">Letter Reference</div>
    <div class="ref-slider">
      <div class="ref-slide">
        <div class="ref-letter-name"></div>
        <div class="ref-forms"></div>
      </div>
      <button type="button" class="ref-nav prev" aria-label="Previous letter">‚Äπ</button>
      <button type="button" class="ref-nav next" aria-label="Next letter">‚Ä∫</button>
    </div>
    <div class="ref-dots"></div>
    <div class="ref-tip">
      Tip: forms are generated using Arabic shaping with the tatweel ‚ÄúŸÄ‚Äù to force joins.<br>
      Beginning: <code>letter + ŸÄ</code>, Middle: <code>ŸÄ + letter + ŸÄ</code>, Final: <code>ŸÄ + letter</code>.
    </div>
  </div>
</div>

<script>
let DATA = [];
let score = 0, total = 0;
let refIndex = 0;
let currentMode = 'form-to-name';
let currentTab = 'letters';

// ===== Quiz Prep Data: Spelling words (from your PDF) =====
// Stored exactly as provided; tatweel and diacritics are preserved
const SPELLING_WORDS = [
  'ÿ¥ŸéÿπŸíÿ±Ÿå',
  'ÿ®ŸèŸÜŸêŸëŸäŸåŸë',
  'ŸÇŸéÿµŸêŸäÿ±Ÿå',
  'ŸÉŸéŸÑŸíÿ®Ÿå',
  'ŸÖŸèÿ±ŸéŸÇŸéŸëÿ∑Ÿå',
  'ÿ™ŸèŸÖŸíÿ≥ŸêŸÉŸè',
  'ŸÑŸèÿπŸíÿ®Ÿéÿ©Ÿå',
  'ŸÉŸèÿ±Ÿéÿ©Ÿé',
  'ÿßŸÑŸíŸÖŸêÿ∂Ÿíÿ±Ÿéÿ®Ÿé'
];

// Utility: Arabic normalization and clustering
const HARAKAT = /[\u064B-\u0652]/g; // tanween + fatha/damma/kasra + shadda + sukun
const TATWEEL = /\u0640/g; // tatweel (kashida)
const ZWJ = /\u200D/g; // zero-width joiner if any

function normalizeArabic(str, { keepHarakat = false } = {}) {
  let s = str.replace(TATWEEL, '').replace(ZWJ, '')
             .replace(/\s+/g, '');
  if (!keepHarakat) s = s.replace(HARAKAT, '');
  // Normalize common variants
  s = s.replace(/\u0649/g, '\u064A'); // Ÿâ -> Ÿä
  return s;
}

// Split into clusters: base + following combining marks (harakat); omit tatweel
function clusterArabic(str) {
  const s = str.replace(TATWEEL, '').replace(ZWJ, '');
  const out = [];
  let current = '';
  for (const ch of s) {
    const isComb = /[\u064B-\u0652]/.test(ch);
    if (!current) {
      if (!/\s/.test(ch)) current = ch;
    } else {
      if (isComb) {
        current += ch;
      } else if (/\s/.test(ch)) {
        if (current) { out.push(current); current = ''; }
      } else {
        out.push(current);
        current = ch;
      }
    }
  }
  if (current) out.push(current);
  return out.filter(Boolean);
}

// Simple transliteration to produce phonetics for matching
function transliterateArabic(str) {
  const baseMap = {
    'ÿß':'aa','ÿ£':'a','ÿ•':'i','ÿ¢':'aa','ÿ°':'\'', 'ÿ§':'\'u','ÿ¶':'\'i',
    'ÿ®':'b','ÿ™':'t','ÿ´':'th','ÿ¨':'j','ÿ≠':'h','ÿÆ':'kh',
    'ÿØ':'d','ÿ∞':'dh','ÿ±':'r','ÿ≤':'z','ÿ≥':'s','ÿ¥':'sh',
    'ÿµ':'s','ÿ∂':'d','ÿ∑':'t','ÿ∏':'z','ÿπ':'\'' ,'ÿ∫':'gh',
    'ŸÅ':'f','ŸÇ':'q','ŸÉ':'k','ŸÑ':'l','ŸÖ':'m','ŸÜ':'n','Ÿá':'h',
    'Ÿà':'w','Ÿä':'y','Ÿâ':'a','ÿ©':'h','ŸÑÿß':'la'
  };
  const vowels = { '\u064E':'a', '\u064F':'u', '\u0650':'i' }; // fatha, damma, kasra
  const tanween = { '\u064B':'an', '\u064C':'un', '\u064D':'in' };
  const SHADDA = '\u0651';

  const clusters = clusterArabic(str);
  const parts = [];
  for (let cl of clusters) {
    const base = cl.replace(/[\u064B-\u0652]/g, '');
    const diacs = cl.replace(/[^\u064B-\u0652]/g, '');
    let roman = '';
    let baseRoman = '';
    if (base.length === 2 && base === 'ŸÑÿß') {
      baseRoman = baseMap['ŸÑÿß'];
    } else {
      const b = base || '';
      baseRoman = (baseMap[b] ?? '');
      if (!baseRoman && b) baseRoman = '?';
    }
    const hasShadda = diacs.includes('\u0651');
    let vow = '';
    for (const d of diacs) { if (tanween[d]) { vow = tanween[d]; break; } }
    if (!vow) { for (const d of diacs) { if (vowels[d]) { vow = vowels[d]; break; } } }
    if (hasShadda && baseRoman) baseRoman = baseRoman + baseRoman;
    roman = baseRoman + (vow || '');
    if (!diacs && ['ÿß','Ÿà','Ÿä','Ÿâ'].includes(base)) {
      roman = (base === 'ÿß' || base === 'Ÿâ') ? 'aa' : (base === 'Ÿà' ? 'uu' : 'ii');
    }
    parts.push(roman);
  }
  return parts.join('-').replace(/--+/g,'-').replace(/^-|-$|\b\-\b/g,'').trim();
}

const SPELLING_PHONETICS = SPELLING_WORDS.map(w => transliterateArabic(w));
const SPELLING_SYLLABLES = SPELLING_PHONETICS.map(p => p.split('-').filter(Boolean));

async function load() {
  const resp = await fetch('letters.json');
  DATA = await resp.json();
  initReference();
  newRound();
}

function updateModeButtons() {
  document.querySelectorAll('.mode-btn').forEach(btn => {
    const isActive = btn.dataset.mode === currentMode;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}

function initModeToggle() {
  document.querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.dataset.mode === currentMode) return;
      currentMode = btn.dataset.mode;
      updateModeButtons();
      newRound();
    });
  });
  updateModeButtons();
}

function pick(n, excludeIdx=null) {
  const pool = DATA.map((_,i)=>i).filter(i=>i!==excludeIdx);
  const out = [];
  while (out.length < n && pool.length) {
    const j = Math.floor(Math.random()*pool.length);
    out.push(pool.splice(j,1)[0]);
  }
  return out;
}

function sample(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function newRound() {
  if (!DATA.length) return;
  total++;
  document.getElementById('score').textContent = `${score} / ${total-1}`;
  const mode = currentMode;
  const container = document.getElementById('quiz');
  container.innerHTML = '';

  const idx = Math.floor(Math.random()*DATA.length);
  const L = DATA[idx];
  const forms = ['beginning','middle','final'];
  const which = sample(forms);

  if (mode === 'form-to-name') {
    const prompt = document.createElement('div');
    prompt.className = 'arabic';
    prompt.textContent = L.forms[which];
    container.appendChild(prompt);
    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = `Which letter is this ${which} form?`;
    container.appendChild(hint);

    const options = [idx, ...pick(3, idx)];
    options.sort(()=>Math.random()-0.5);
    const grid = document.createElement('div'); grid.className='grid';
    options.forEach(i=>{
      const b = document.createElement('button');
      b.textContent = DATA[i].name;
      b.onclick = () => grade(b, i===idx);
      grid.appendChild(b);
    });
    container.appendChild(grid);
  } else {
    const title = document.createElement('div');
    title.className = 'name';
    title.textContent = L.name;
    container.appendChild(title);
    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = 'Pick the requested form:';
    container.appendChild(hint);

    const ask = sample(['beginning','middle','final']);
    const askEl = document.createElement('div');
    askEl.className = 'muted';
    askEl.textContent = `Find the ${ask} form`;
    container.appendChild(askEl);

    const distractors = ['beginning','middle','final'].filter(f=>f!==ask);
    const shown = [ask, ...distractors];
    shown.sort(()=>Math.random()-0.5);

    const grid = document.createElement('div'); grid.className='grid';
    shown.forEach(kind=>{
      const b = document.createElement('button');
      b.innerHTML = `<div class="arabic small">${L.forms[kind]}</div><div class="muted">${kind}</div>`;
      b.onclick = () => grade(b, kind===ask);
      grid.appendChild(b);
    });
    container.appendChild(grid);
  }

  container.dataset.answerIdx = idx;
  container.dataset.which = which;
  refIndex = idx;
  updateReferenceSlide();
}

function grade(button, correct) {
  if (button.classList.contains('correct') || button.classList.contains('wrong')) return;
  const buttons = button.parentElement.querySelectorAll('button');
  buttons.forEach(b=>b.disabled=true);
  
  const messages = {
    correct: [
      "Amazing! üåü", 
      "Great job! üéâ", 
      "You're a star! ‚≠ê", 
      "Fantastic! üéà",
      "Keep it up! üöÄ"
    ],
    wrong: [
      "Try again! üí™",
      "You can do it! üåà",
      "Keep learning! üìö",
      "Don't give up! üåü",
      "Almost there! üéØ"
    ]
  };

  if (correct) { 
    button.classList.add('correct'); 
    score++; 
    showMessage(messages.correct[Math.floor(Math.random() * messages.correct.length)], 'correct');
  } else { 
    button.classList.add('wrong');
    showMessage(messages.wrong[Math.floor(Math.random() * messages.wrong.length)], 'wrong');
  }
  document.getElementById('score').textContent = `${score} / ${total}`;
}

function showMessage(text, type) {
  const msg = document.createElement('div');
  msg.className = `message ${type}`;
  msg.textContent = text;
  msg.style.position = 'fixed';
  msg.style.top = '50%';
  msg.style.left = '50%';
  msg.style.transform = 'translate(-50%, -50%)';
  msg.style.backgroundColor = type === 'correct' ? '#a8e6cf' : '#ffb8b8';
  msg.style.padding = '20px 40px';
  msg.style.borderRadius = '20px';
  msg.style.fontSize = '24px';
  msg.style.fontWeight = 'bold';
  msg.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
  msg.style.zIndex = '1000';
  msg.style.opacity = '0';
  msg.style.transition = 'opacity 0.3s ease';
  
  document.body.appendChild(msg);
  setTimeout(() => msg.style.opacity = '1', 10);
  setTimeout(() => {
    msg.style.opacity = '0';
    setTimeout(() => msg.remove(), 300);
  }, 1500);
}

function initReference() {
  const panel = document.getElementById('reference-panel');
  const dotsWrap = panel.querySelector('.ref-dots');
  dotsWrap.innerHTML = '';
  refIndex = 0;

  DATA.forEach((_, idx) => {
    const dot = document.createElement('button');
    dot.type = 'button';
    dot.className = 'ref-dot';
    dot.dataset.index = idx;
    dot.addEventListener('click', () => {
      refIndex = idx;
      updateReferenceSlide();
    });
    dotsWrap.appendChild(dot);
  });

  panel.querySelector('.ref-nav.prev').addEventListener('click', () => shiftReference(-1));
  panel.querySelector('.ref-nav.next').addEventListener('click', () => shiftReference(1));
  panel.querySelector('.ref-close').addEventListener('click', () => toggleReference(false));
  panel.querySelector('.ref-backdrop').addEventListener('click', () => toggleReference(false));

  const helpButton = document.getElementById('help');
  helpButton.addEventListener('click', () => {
    toggleReference(!panel.classList.contains('active'));
  });

  document.addEventListener('keydown', (event) => {
    if (!panel.classList.contains('active')) return;
    if (event.key === 'Escape') {
      toggleReference(false);
    } else if (event.key === 'ArrowRight') {
      shiftReference(1);
    } else if (event.key === 'ArrowLeft') {
      shiftReference(-1);
    }
  });

  updateReferenceSlide();
}

function shiftReference(delta) {
  if (!DATA.length) return;
  refIndex = (refIndex + delta + DATA.length) % DATA.length;
  updateReferenceSlide();
}

function updateReferenceSlide() {
  if (!DATA.length) return;
  const panel = document.getElementById('reference-panel');
  const letter = DATA[refIndex];
  const formsRoot = panel.querySelector('.ref-forms');
  panel.querySelector('.ref-letter-name').textContent = letter.name;
  formsRoot.innerHTML = '';

  const order = [
    ['beginning', 'Beginning'],
    ['middle', 'Middle'],
    ['final', 'Final']
  ];

  order.forEach(([key, label]) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'ref-forms-row';
    wrapper.innerHTML = `
      <span class="label">${label}</span>
      <span class="glyph">${letter.forms[key]}</span>
    `;
    formsRoot.appendChild(wrapper);
  });

  panel.querySelectorAll('.ref-dot').forEach((dot, idx) => {
    dot.classList.toggle('active', idx === refIndex);
  });
}

function toggleReference(show) {
  const panel = document.getElementById('reference-panel');
  panel.classList.toggle('active', show);
  panel.setAttribute('aria-hidden', show ? 'false' : 'true');
  document.body.classList.toggle('no-scroll', show);
  if (show) {
    panel.querySelector('.ref-card').focus();
  } else {
    document.getElementById('help').focus();
  }
}

document.getElementById('next').onclick = newRound;
initModeToggle();
load();

// ===== Top Tab switching (Letters vs Quiz Prep) =====
function updateTabs() {
  const tabs = document.querySelectorAll('.top-tab');
  tabs.forEach(t => {
    const active = t.dataset.tab === currentTab;
    t.classList.toggle('active', active);
    t.setAttribute('aria-selected', active ? 'true' : 'false');
  });
  const letters = document.getElementById('letters-section');
  const prep = document.getElementById('prep-section');
  if (letters && prep) {
    letters.hidden = currentTab !== 'letters';
    prep.hidden = currentTab !== 'prep';
  }
  const modeToggle = document.querySelector('.mode-toggle');
  if (modeToggle) modeToggle.style.display = currentTab === 'letters' ? '' : 'none';

  // Bring the active view front and center
  const target = currentTab === 'prep' ? prep : letters;
  if (target) {
    if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex', '-1');
    requestAnimationFrame(() => {
      try { target.focus({ preventScroll: true }); } catch (e) {}
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  }
}

document.querySelectorAll('.top-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentTab === btn.dataset.tab) return;
    currentTab = btn.dataset.tab;
    updateTabs();
    if (currentTab === 'prep') initPrepOnce();
  });
});

updateTabs();

// ===== Quiz Prep logic =====
let prepInitialized = false;
let prepMode = 'letter-order';
let prepWordIndex = 0;

function initPrepOnce() {
  if (prepInitialized) { renderPrep(); return; }
  prepInitialized = true;
  document.querySelectorAll('.prep-mode-btn').forEach(b => {
    b.addEventListener('click', () => {
      if (prepMode === b.dataset.prep) return;
      prepMode = b.dataset.prep;
      document.querySelectorAll('.prep-mode-btn').forEach(x => x.classList.toggle('active', x === b));
      renderPrep();
    });
  });
  renderPrep();
}

function renderPrep() {
  const root = document.getElementById('prep-container');
  if (!root) return;
  root.innerHTML = '';
  if (prepMode === 'letter-order') {
    renderLetterOrder(root);
  } else if (prepMode === 'phonetic-match') {
    renderPhoneticMatch(root);
  } else if (prepMode === 'type-it') {
    renderTypeIt(root);
  } else if (prepMode === 'flashcards') {
    renderFlashcards(root);
  }
}

// Mode: Letter Order ‚Äî select each letter in order
function renderLetterOrder(root) {
  const word = SPELLING_WORDS[prepWordIndex];
  const clusters = clusterArabic(word);
  const shuffled = [...clusters].sort(() => Math.random() - 0.5);

  const title = document.createElement('div');
  title.className = 'prep-muted';
  title.textContent = `Word ${prepWordIndex + 1} ‚Äî select the letters in order`;
  root.appendChild(title);

  const slots = document.createElement('div');
  slots.className = 'slots prep-rtl';
  clusters.forEach(() => {
    const s = document.createElement('div');
    s.className = 'slot';
    slots.appendChild(s);
  });
  root.appendChild(slots);

  const bank = document.createElement('div');
  bank.className = 'tiles prep-rtl';
  shuffled.forEach((cl) => {
    const tile = document.createElement('button');
    tile.type = 'button';
    tile.className = 'tile';
    tile.textContent = cl;
    tile.addEventListener('click', () => {
      if (tile.classList.contains('used')) return;
      const nextIndex = Array.from(slots.children).findIndex(c => !c.classList.contains('filled'));
      if (nextIndex === -1) return;
      const should = clusters[nextIndex];
      if (cl === should) {
        const target = slots.children[nextIndex];
        target.textContent = cl;
        target.classList.add('filled');
        tile.classList.add('used');
        if (Array.from(slots.children).every(c => c.classList.contains('filled'))) {
          const done = document.createElement('div');
          done.className = 'status';
          done.textContent = 'Great job! ‚úî Assembled correctly.';
          root.appendChild(done);
        }
      } else {
        tile.style.background = '#ffb8b8';
        setTimeout(() => tile.style.background = '', 250);
      }
    });
    bank.appendChild(tile);
  });
  root.appendChild(bank);

  const actions = document.createElement('div');
  actions.className = 'prep-actions';
  const prev = document.createElement('button'); prev.className = 'prep-btn'; prev.textContent = 'Prev Word';
  const nextBtn = document.createElement('button'); nextBtn.className = 'prep-btn'; nextBtn.textContent = 'Next Word';
  const reset = document.createElement('button'); reset.className = 'prep-btn secondary'; reset.textContent = 'Reset';
  prev.onclick = () => { prepWordIndex = (prepWordIndex - 1 + SPELLING_WORDS.length) % SPELLING_WORDS.length; renderPrep(); };
  nextBtn.onclick = () => { prepWordIndex = (prepWordIndex + 1) % SPELLING_WORDS.length; renderPrep(); };
  reset.onclick = () => renderPrep();
  actions.append(prev, nextBtn, reset);
  root.appendChild(actions);
}

// Mode: Phonetic Match ‚Äî match Arabic words to transliteration
function renderPhoneticMatch(root) {
  const left = SPELLING_WORDS.map((w, i) => ({ i, w }));
  const right = SPELLING_PHONETICS.map((p, i) => ({ i, p }));
  right.sort(() => Math.random() - 0.5);

  let selLeft = null, selRight = null, matched = new Set();

  const grid = document.createElement('div');
  grid.className = 'prep-two-col';

  const colL = document.createElement('div'); colL.className = 'prep-col';
  const colR = document.createElement('div'); colR.className = 'prep-col';
  colL.innerHTML = '<h3>Words</h3>';
  colR.innerHTML = '<h3>Phonetics</h3>';

  const listL = document.createElement('div'); listL.className = 'tiles prep-rtl';
  const listR = document.createElement('div'); listR.className = 'tiles';

  left.forEach(({i, w}) => {
    const b = document.createElement('button'); b.type = 'button'; b.className = 'pair-item prep-rtl'; b.textContent = w; b.dataset.i = i;
    b.addEventListener('click', () => {
      if (matched.has(i)) return;
      listL.querySelectorAll('.pair-item').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected'); selLeft = i; tryResolve();
    });
    listL.appendChild(b);
  });

  right.forEach(({i, p}) => {
    const b = document.createElement('button'); b.type = 'button'; b.className = 'pair-item'; b.textContent = p; b.dataset.i = i;
    b.addEventListener('click', () => {
      if (matched.has(i)) return;
      listR.querySelectorAll('.pair-item').forEach(x => x.classList.remove('selected'));
      b.classList.add('selected'); selRight = i; tryResolve();
    });
    listR.appendChild(b);
  });

  function tryResolve() {
    if (selLeft == null || selRight == null) return;
    const good = selLeft === selRight;
    const Lbtn = listL.querySelector(`.pair-item[data-i="${selLeft}"]`);
    const Rbtn = listR.querySelector(`.pair-item[data-i="${selRight}"]`);
    if (good) {
      matched.add(selLeft);
      [Lbtn, Rbtn].forEach(el => { el.classList.add('matched'); el.classList.remove('selected'); el.disabled = true; });
      showMessage('Nice match! ‚úÖ', 'correct');
      if (matched.size === SPELLING_WORDS.length) {
        const done = document.createElement('div'); done.className = 'status'; done.textContent = 'All matched! Great work.'; root.appendChild(done);
      }
    } else {
      [Lbtn, Rbtn].forEach(el => { el.classList.remove('selected'); el.style.background = '#fee2e2'; setTimeout(()=> el.style.background='', 250); });
      showMessage('Not a match, try again.', 'wrong');
    }
    selLeft = selRight = null;
  }

  colL.appendChild(listL); colR.appendChild(listR);
  grid.append(colL, colR);
  root.appendChild(grid);
}

// Mode: Type It ‚Äî show phonetics, student types the Arabic word
function renderTypeIt(root) {
  const word = SPELLING_WORDS[prepWordIndex];
  const phon = SPELLING_PHONETICS[prepWordIndex];
  const h = document.createElement('div'); h.className = 'prep-muted'; h.textContent = `Type the Arabic for: ${phon}`; root.appendChild(h);
  const input = document.createElement('input'); input.type = 'text'; input.className = 'prep-input'; input.setAttribute('dir','rtl'); input.placeholder = 'ÿßŸÉÿ™ÿ® ÿßŸÑŸÉŸÑŸÖÿ© ŸáŸÜÿß';
  root.appendChild(input);
  const status = document.createElement('div'); status.className = 'status'; root.appendChild(status);

  input.addEventListener('input', () => {
    const got = normalizeArabic(input.value);
    const want = normalizeArabic(word);
    if (!got) { status.textContent=''; return; }
    if (got === want) { status.textContent = 'Correct! ‚úÖ'; status.style.color = '#16a34a'; }
    else { status.textContent = 'Keep trying‚Ä¶'; status.style.color = '#ef4444'; }
  });

  const actions = document.createElement('div'); actions.className = 'prep-actions';
  const prev = document.createElement('button'); prev.className = 'prep-btn'; prev.textContent = 'Prev Word';
  const nextBtn = document.createElement('button'); nextBtn.className = 'prep-btn'; nextBtn.textContent = 'Next Word';
  prev.onclick = () => { prepWordIndex = (prepWordIndex - 1 + SPELLING_WORDS.length) % SPELLING_WORDS.length; renderPrep(); };
  nextBtn.onclick = () => { prepWordIndex = (prepWordIndex + 1) % SPELLING_WORDS.length; renderPrep(); };
  actions.append(prev, nextBtn); root.appendChild(actions);
}

// Mode: Flashcards ‚Äî reveal phonetics
function renderFlashcards(root) {
  const word = SPELLING_WORDS[prepWordIndex];
  const phon = SPELLING_PHONETICS[prepWordIndex];
  const card = document.createElement('div'); card.className = 'prep-col';
  const w = document.createElement('div'); w.className = 'prep-arabic-word prep-rtl'; w.textContent = word; card.appendChild(w);
  const reveal = document.createElement('button'); reveal.className = 'prep-btn secondary'; reveal.textContent = 'Show phonetics';
  const p = document.createElement('div'); p.className = 'prep-muted'; p.style.fontSize = '20px'; p.style.marginTop = '8px'; p.textContent = '';
  reveal.onclick = () => { p.textContent = phon; };
  card.append(reveal, p);
  root.appendChild(card);
  const actions = document.createElement('div'); actions.className = 'prep-actions';
  const prev = document.createElement('button'); prev.className = 'prep-btn'; prev.textContent = 'Prev';
  const nextBtn = document.createElement('button'); nextBtn.className = 'prep-btn'; nextBtn.textContent = 'Next';
  prev.onclick = () => { prepWordIndex = (prepWordIndex - 1 + SPELLING_WORDS.length) % SPELLING_WORDS.length; renderPrep(); };
  nextBtn.onclick = () => { prepWordIndex = (prepWordIndex + 1) % SPELLING_WORDS.length; renderPrep(); };
  actions.append(prev, nextBtn); root.appendChild(actions);
}
</script>
</body>
</html>
